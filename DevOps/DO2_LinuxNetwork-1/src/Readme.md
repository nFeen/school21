## Part 1. Инструмент **ipcalc**
#### 1.1. Сети и маски
1) Адрес сети:  
   ![image1](<Images/Pasted image 20250324233050.png>)
2) **Перевод маски 255.255.255.0 в префиксную и двоичную запись:**  
   Префиксная - 24  
   Двоичная - 11111111.11111111.11111111.00000000  
   **Перевод маски /15 в обычную и двоичную запись:**  
   Обычная - 255.254.0.0  
   Двоичная - 11111111.11111110.00000000.00000000  
   **Перевод 11111111.11111111.11111111.11110000 в обычную и префиксную запись:**  
   Обычная - 255.255.255.240  
   Префиксная - 28
3) Минимальный и максимальный хост в сети _12.167.38.4_ при масках:  
   _**/8:**_  
   ![image2](<Images/Pasted image 20250325002358.png>)  
   **_11111111.11111111.00000000.00000000:_**  
   ![image3](<Images/Pasted image 20250325002539.png>)  
   **_255.255.254.0:_**  
   ![image4](<Images/Pasted image 20250325002703.png>)  
   **_/4:_**  
   ![image5](<Images/Pasted image 20250325002932.png>)
#### 1.2. localhost
Можно ли обратиться к приложению, работающему на localhost, со следующими IP:  
_194.34.23.100_ - нет, так как это публичный адрес  
_127.0.0.2_ - да, если приложение слушает этот адрес  
_127.1.0.1_ - да, если приложение слушает этот адрес  
_128.0.0.1_ - нет, так как это публичный адрес
#### 1.3. Диапазоны и сегменты сетей
1) Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: _10.0.0.45_, _134.43.0.2_, _192.168.4.2_, _172.20.250.4_, _172.0.2.1_, _192.172.0.1_, _172.68.0.2_, _172.16.255.255_, _10.10.10.10_, _192.169.168.1_  
   Ответ:  
   10.0.0.45 - только частный  
   134.43.0.2 - публичный  
   192.168.4.2 - только частный  
   172.20.250.4 - только частный  
   172.0.2.1 - публичный  
   192.172.0.1 - публичный  
   172.68.0.2 - публичный  
   172.16.255.255 - только частный  
   10.10.10.10 - только частный  
   192.169.168.1 - публичный
2) Какие из перечисленных IP-адресов шлюза возможны у сети _10.10.0.0/18_: _10.0.0.1_, _10.10.0.2_, _10.10.10.10_, _10.10.100.1_, _10.10.1.255_  
   Ответ: 10.10.0.2 10.10.10.10
## Part 2. Статическая маршрутизация между двумя машинами
- Существующие сетевые интерфейсы (на обоих машинах одинаковые, так как это клоны)  
  ![image6](<Images/Pasted image 20250326001935.png>)
- Описание сетевого интерфейса, соответствующего внутренней сети, на обеих машинах  
  ws1 (192.168.100.10/16):  
  ![image7](<Images/Pasted image 20250326003748.png>)  
  ws2 (172.24.116.8/12):  
  ![image8](<Images/Pasted image 20250326003958.png>)
- Выполняем команду netplan apply для перезапуска сервиса сети:  
  ws1:  
  ![image9](<Images/Pasted image 20250326004324.png>)  
  ws2:  
  ![image10](<Images/Pasted image 20250326004342.png>)
#### 2.1. Добавление статического маршрута вручную
Для добавления статического маршрута используем команду `ip route add [адрес сети/маска] dev [интерфейс]`  
ws1:  
![image11](<Images/Pasted image 20250326012852.png>)  
ws2:  
![image12](<Images/Pasted image 20250326012910.png>)  
Пингуем ws2 с ws1:  
![image13](<Images/Pasted image 20250326012952.png>)  
Пингуем ws1 с ws2:  
![image14](<Images/Pasted image 20250326013037.png>)
#### 2.2. Добавление статического маршрута с сохранением
- Добавляем статический маршрут от одной машины до другой с помощью файла _/etc/netplan/00-installer-config.yaml_  
  ws1:  
  ![image15](<Images/Pasted image 20250326015155.png>)  
  ws2:  
  ![image16](<Images/Pasted image 20250326015252.png>)
- Пингуем ws2 с ws1  
  ![image17](<Images/Pasted image 20250326015445.png>)  
  Пингуем ws1 с ws2  
  ![image18](<Images/Pasted image 20250326015523.png>)
## Part 3. Утилита **iperf3**
#### 3.1. Скорость соединения
8 Mbps = 1 MB/s  
100 MB/s = (100 \* 8 \* 1024) Kbps = 819 200 Kbps  
1 Gbps = 1024 Mbps
#### 3.2. Утилита **iperf3**
Используем ws1 в качестве сервера для iperf3  
![image19](<Images/Pasted image 20250326171525.png>)  
Используем ws2 в качестве клиента  
![image20](<Images/Pasted image 20250326171620.png>)
## Part 4. Сетевой экран
#### 4.1. Утилита iptables
- Содержание файла /etc/firewall.sh  
  ws1:  
  ![image21](<Images/Pasted image 20250326232525.png>)
  
  ws2:  
  ![image22](<Images/Pasted image 20250326232544.png>)
- Запускаем скрипт  
  ws1:  
  ![image23](<Images/Pasted image 20250326232105.png>)  
  ws2:  
  ![image24](<Images/Pasted image 20250326232035.png>)
- Разница между подходами на ws1 и ws2: iptables применяет правило сразу как дошло до него сверху вниз, соответственно, когда мы ставим сначала запрещающее правило, а потом разрешающее, то по итогу разрешающее правило не учитывается. Следовательно, ws1 мы пропинговать не можем, а ws2 можем.
#### 4.2. Утилита nmap
- ws1 не пингуется  
  ![image25](<Images/Pasted image 20250326235541.png>)
- При этом Host is up  
  ![image26](<Images/Pasted image 20250327010644.png>)
## Part 5. Статическая маршрутизация сети
#### 5.1. Настройка адресов машин
- Конфигурации машин в _etc/netplan/00-installer-config.yaml_  
  ws11:  
  ![image27](<Images/Pasted image 20250327114442.png>)  
  ws21:  
  ![image28](<Images/Pasted image 20250327114810.png>)  
  ws22:  
  ![image29](<Images/Pasted image 20250327115032.png>)  
  r1:  
  ![image30](<Images/Pasted image 20250327115058.png>)  
  r2:  
  ![image31](<Images/Pasted image 20250327115230.png>)
- Перезапускаем сервис сети и командой `ip -4 a` проверяем, что адрес машины задан верно  
  ws11:  
  ![image32](<Images/Pasted image 20250327201349.png>)  
  ws21:  
  ![image33](<Images/Pasted image 20250327201429.png>)  
  ws22:  
  ![image34](<Images/Pasted image 20250327201508.png>)  
  r1:  
  ![image35](<Images/Pasted image 20250327201542.png>)  
  r2:  
  ![image36](<Images/Pasted image 20250327201611.png>)  
  Пингуем ws22 с ws21:  
  ![image37](<Images/Pasted image 20250327201800.png>)  
  Пингуем r1 с ws11:  
  ![image38](<Images/Pasted image 20250327201922.png>)
#### 5.2. Включение переадресации IP-адресов
- Включаем ip forwarding без сохранения на r1 (на r2 аналогично)  
  ![image39](<Images/Pasted image 20250327202926.png>)
- Включаем ip forwarding с сохранением с помощью файла /etc/sysctl.conf на r1 (на r2 аналогично)  
  ![image40](<Images/Pasted image 20250327203805.png>)
#### 5.3. Установка маршрута по умолчанию
- Настраиваем шлюз по умолчанию для рабочих станций. Для этого добавляем `default` маршрут  
  ws11:  
  ![image41](<Images/Pasted image 20250327204847.png>)  
  ws21:  
  ![image42](<Images/Pasted image 20250327205113.png>)  
  ws22:  
  ![image43](<Images/Pasted image 20250327205326.png>)
- Таблица маршрутизации  
  ws11:  
  ![image44](<Images/Pasted image 20250327205558.png>)  
  ws21:  
  ![image45](<Images/Pasted image 20250327205615.png>)  
  ws22:  
  ![image46](<Images/Pasted image 20250327205641.png>)
- Пингуем c ws11 роутер r2  
  ![image47](<Images/Pasted image 20250328130005.png>)  
  Пакеты не возвращаются, но доходят. Это можно проверить с помощью `tcpdump -tn -i eth0`  
  ![image48](<Images/Pasted image 20250328130021.png>)
#### 5.4. Добавление статических маршрутов
- Добавляем в роутеры r1 и r2 статические маршруты в файле конфигураций  
  r1:  
  ![image49](<Images/Pasted image 20250328181735.png>)  
  
  r2:  
  ![image50](<Images/Pasted image 20250328182239.png>)
- Вызов `ip r` для вывода таблиц с маршрутами на обоих роутерах  
  r1:  
  ![image51](<Images/Pasted image 20250328182946.png>)  
  
  r2:  
  ![image52](<Images/Pasted image 20250328183055.png>)  
- Вывод команд `ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0`  
  ![image53](<Images/Pasted image 20250328184216.png>)  
  
  Почему для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по умолчанию?  
  Это локальный маршрут, который создается автоматически для всех интерфейсов, и это помогает хосту избежать ненужной передачи пакетов через маршрутизатор, если сеть доступна напрямую
#### 5.5. Построение списка маршрутизаторов
- Использование утилиты `traceroute` от ws11 до ws21  
  ![image54](<Images/Pasted image 20250329013319.png>)  
  Использование `tcpdump` на r1  
  ![image55](<Images/Pasted image 20250329013410.png>)
- `traceroute` отправляет множество пакетов с ограниченным Time to live и на каждом роутере один из пакетов умирает и отправляет сообщение Time exceeded обратно отправителю, так можно понять через какие узлы проходит пакет. Также вместе с ICMP пакетами отправляются UDP пакеты, они нужны, чтобы на конечном узле, вернулось сообщение о том, что такого порта нет, так можно понять, что трассировка закончилась
#### 5.6. Использование протокола **ICMP** при маршрутизации
Запускаем `tcpdump` на r1 и пингуем на ws11 несуществующий IP  
Вывод команды `ping`  
![image56](<Images/Pasted image 20250329162448.png>)  
Вывод команды `tcpdump`  
![image57](<Images/Pasted image 20250329162551.png>)
## Part 6. Динамическая настройка IP с помощью **DHCP**
- Указываем адрес маршрутизатора по умолчанию, DNS-сервер и адрес внутренней сети на r2  
  ![image58](<Images/Pasted image 20250329201211.png>)  
  В файле _resolv.conf_ прописываем `nameserver 8.8.8.8`  
  ![image59](<Images/Pasted image 20250329201502.png>)
- Через `ip a` можно посмотреть, что ws21 получила адрес  
  ![image60](<Images/Pasted image 20250329212112.png>)  
  Пингуем ws22 с ws21  
  ![image61](<Images/Pasted image 20250329212129.png>)
- Указываем MAC-адрес у ws11, для этого в _etc/netplan/00-installer-config.yaml_ надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`  
  ![image62](<Images/Pasted image 20250330124949.png>)
- Для r1 настраиваем аналогично r2, но сделаем выдачу адресов с жесткой привязкой к MAC-адресу (ws11)  
  ![image63](<Images/Pasted image 20250329221606.png>)  
  Затем добавим в `/etc/resolv.conf` строку `nameserver 8.8.8.8`  
  ![image64](<Images/Pasted image 20250330125220.png>)  
  Пишем `ip a` на ws11, чтобы убедиться, что получен адрес `10.10.0.2`  
  ![image65](<Images/Pasted image 20250330125654.png>)  
  Пингуем ws22 с ws11  
  ![image66](<Images/Pasted image 20250330125852.png>)
- Обновляем ip адрес у ws21  
  ip адрес до обновления:  
  ![image67](<Images/Pasted image 20250330130051.png>)  
  Затем прописываем следующие команды, чтобы сбросить и получить новые данные по dhcp:  
  ![image68](<Images/Pasted image 20250330130131.png>)  
  ip адрес после обновления:  
  ![image69](<Images/Pasted image 20250330130212.png>)
## Part 7. **NAT**
- В файле _/etc/apache2/ports.conf_ на ws22 и r1 изменяем строку `Listen 80` на `Listen 0.0.0.0:80`  
  ![image70](<Images/Pasted image 20250330185210.png>)
- Запускаем apache на ws22 и r1  
  ![image71](<Images/Pasted image 20250330185722.png>)
- После добавления правила FORWARD DROP на r2 ws22 не может пинговать r1:  
  ![image72](<Images/Pasted image 20250330194147.png>)
- Добавляем правило на r2, которое разрешает маршрутизацию всех icmp пакетов  
  ![image73](<Images/Pasted image 20250330194931.png>)  
  Запускаем этот скрипт и видим, что пинги от r1 до ws22 доходят  
  ![image74](<Images/Pasted image 20250330195400.png>)
- Включаем **SNAT**, а именно маскирование всех локальных IP из локальной сети, находящейся за r2 (по обозначениям из Части 5 — сеть 10.20.0.0). И включаем **DNAT** на 8080 порт машины r2  
  ![image75](<Images/Pasted image 20250401160430.png>)
- Проверяем соединение по TCP для **SNAT**: для этого с ws22 подключаемся к серверу Apache на r1 через `telnet`  
  ![image76](<Images/Pasted image 20250401160839.png>)  
  Проверяем соединение по TCP для **DNAT**: для этого с r1 подключаемся к серверу Apache на ws22 командой `telnet` (обращаемся по адресу r2 и порту 8080)  
  ![image77](<Images/Pasted image 20250401161016.png>)  
  Подключения успешно выполнены
## Part 8. Дополнительно. Знакомство с **SSH Tunnels**
Запускаем веб-сервер **Apache** на ws22 только на localhost (то есть в файле _/etc/apache2/ports.conf_ изменяем строку `Listen 80` на `Listen localhost:80`)  
![image78](<Images/Pasted image 20250401190224.png>)  
Воспользуемся _Local TCP forwarding_ с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21. Для этого пропишем `ssh -N -L 8888:localhost:80 saadthai@10.20.0.20` (-N необязательна, так как эта опция просто дает возможность подключиться по ssh без входа в интерактивный режим). `8888:localhost:80` означает, что при попытке подключения на локальном хосте ws21 к адресу `localhost:8888` мы подключимся через ssh сервер (в данном случае это сам хост, на котором стоит apache) к адресу `localhost:80` на удаленном хосте ws22  
![image79](<Images/Pasted image 20250401192615.png>)  
Проверяем подключение по Local TCP forwarding с помощью команды `telnet` на ws21  
![image80](<Images/Pasted image 20250401191920.png>)  
Воспользуемся _Remote TCP forwarding_ c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11. Для этого пропишем команду `ssh -N -R 8888:localhost:80 saadthai@10.10.0.2` (-N опять необязательна). 8888:localhost:80 означает, что при попытке с удаленного хоста ws11 подключиться к адресу `localhost:8888` он подключится к нашему локальному хосту ws22 по адресу `localhost:80`  
![image81](<Images/Pasted image 20250401194021.png>)  
Проверяем подключение по Remote TCP forwarding с помощью команды `telnet` на ws11  
![image82](<Images/Pasted image 20250401193906.png>)